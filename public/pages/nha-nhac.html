<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kh√°m ph√° Nh√£ Nh·∫°c Cung ƒê√¨nh Hu·∫ø - 3D Experience</title>
    <link rel="shortcut icon" href="../../favicon.svg" type="image/x-icon" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Roboto:wght@300;400;700&display=swap");

      body {
        margin: 0;
        overflow: hidden;
        background-color: #000;
        font-family: "Roboto", sans-serif;
        user-select: none;
      }
      h1,
      h2,
      h3,
      .royal-font {
        font-family: "Playfair Display", serif;
      }

      #game-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      /* UI Overlays */
      #ui-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 10;
        pointer-events: none;
      }

      #crosshair {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 6px;
        height: 6px;
        background-color: rgba(255, 215, 0, 0.8);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: all 0.2s;
      }
      #crosshair.active {
        width: 12px;
        height: 12px;
        background-color: #fff;
        box-shadow: 0 0 10px #ffd700;
      }

      #tooltip {
        position: absolute;
        top: 55%;
        left: 50%;
        transform: translateX(-50%);
        color: #ffd700;
        text-shadow: 1px 1px 3px #000;
        font-size: 18px;
        opacity: 0;
        transition: opacity 0.2s;
        background: rgba(0, 0, 0, 0.6);
        padding: 4px 12px;
        border-radius: 4px;
        border: 1px solid #ffd700;
      }

      #quest-tracker {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(20, 10, 5, 0.8);
        border: 1px solid #8b0000;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(139, 0, 0, 0.5);
        pointer-events: auto;
      }

      /* Start Screen */
      #blocker {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        z-index: 50;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        pointer-events: auto;
      }

      /* Modals */
      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 40;
        display: none;
        justify-content: center;
        align-items: center;
        pointer-events: auto;
        backdrop-filter: blur(5px);
      }
      .modal-content {
        background: linear-gradient(135deg, #2a0800 0%, #1a0500 100%);
        border: 2px solid #ffd700;
        box-shadow:
          0 0 30px rgba(255, 215, 0, 0.2),
          inset 0 0 20px rgba(0, 0, 0, 0.8);
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        color: #e0d0b0;
        padding: 30px;
        border-radius: 4px;
        position: relative;
      }

      /* Timeline specific */
      .timeline-item {
        border-left: 2px solid #ffd700;
        padding-left: 20px;
        position: relative;
        margin-bottom: 20px;
      }
      .timeline-item::before {
        content: "";
        position: absolute;
        left: -6px;
        top: 5px;
        width: 10px;
        height: 10px;
        background: #8b0000;
        border: 2px solid #ffd700;
        border-radius: 50%;
      }

      /* 3D CSS Models for Instruments */
      .css-3d-container {
        perspective: 800px;
        display: flex;
        justify-content: space-around;
        margin-top: 20px;
      }
      .css-model {
        width: 80px;
        height: 80px;
        position: relative;
        transform-style: preserve-3d;
        animation: spin 8s infinite linear;
      }
      @keyframes spin {
        from {
          transform: rotateY(0deg);
        }
        to {
          transform: rotateY(360deg);
        }
      }
      .drum-face {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: #8b0000;
        border: 4px solid #ffd700;
      }
      .drum-side {
        position: absolute;
        width: 100%;
        height: 40px;
        background: #5c4033;
        top: 20px;
        transform: rotateX(90deg);
      }
      .lute-body {
        position: absolute;
        width: 60px;
        height: 80px;
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        background: #5c4033;
        border: 2px solid #ffd700;
        left: 10px;
      }
      .lute-neck {
        position: absolute;
        width: 10px;
        height: 60px;
        background: #3e2723;
        top: -50px;
        left: 35px;
      }

      /* Cinematic Sequence */
      #cinematic-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 100;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        pointer-events: auto;
        text-align: center;
        overflow: hidden;
      }
      #end-video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1a0500;
      }
      ::-webkit-scrollbar-thumb {
        background: #8b0000;
        border: 1px solid #ffd700;
      }

      .btn-royal {
        background: linear-gradient(to bottom, #8b0000, #4a0000);
        border: 2px solid #ffd700;
        color: #ffd700;
        padding: 10px 24px;
        font-family: "Playfair Display", serif;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 2px;
      }
      .btn-royal:hover {
        background: linear-gradient(to bottom, #ffd700, #b8860b);
        color: #4a0000;
        box-shadow: 0 0 15px #ffd700;
      }
    </style>
  </head>
  <body>
    <!-- 3D WebGL Canvas Container -->
    <div id="game-container"></div>

    <!-- UI Layer -->
    <div id="ui-layer">
      <div id="crosshair"></div>
      <div id="tooltip">[E] Kh√°m ph√° hi·ªán v·∫≠t</div>

      <div id="quest-tracker">
        <h3
          class="royal-font text-yellow-500 text-xl border-b border-red-800 pb-2 mb-2"
        >
          Ti·∫øn ƒë·ªô kh√°m ph√°
        </h3>
        <div class="text-gray-300 text-lg">
          Hi·ªán v·∫≠t:
          <span id="progress-text" class="text-yellow-400 font-bold">0</span>/5
        </div>
        <ul id="quest-list" class="mt-2 text-sm text-gray-500 space-y-1">
          <li id="q1">- T·ªïng quan Nh√£ nh·∫°c</li>
          <li id="q2">- L·ªãch s·ª≠ h√¨nh th√†nh</li>
          <li id="q3">- H·ªá th·ªëng nh·∫°c kh√≠</li>
          <li id="q4">- Gi√° tr·ªã ngh·ªá thu·∫≠t</li>
          <li id="q5">- Tr·∫£i nghi·ªám ng√†y nay</li>
        </ul>
      </div>
    </div>

    <!-- Start Menu -->
    <div id="blocker">
      <div
        class="text-center bg-black bg-opacity-80 p-10 border-4 border-red-900 rounded-lg shadow-[0_0_50px_rgba(255,215,0,0.2)]"
      >
        <h1
          class="text-5xl text-yellow-500 mb-4 drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]"
        >
          KH√ÅM PH√Å NH√É NH·∫†C CUNG ƒê√åNH HU·∫æ
        </h1>
        <p class="text-gray-300 mb-8 text-lg italic">
          M·ªôt tr·∫£i nghi·ªám t∆∞∆°ng t√°c 3D
        </p>
        <div class="flex justify-center space-x-8 text-gray-400 mb-8">
          <div>
            <span
              class="font-bold text-white border border-gray-500 px-2 py-1 rounded mr-2"
              >W A S D</span
            >
            Di chuy·ªÉn
          </div>
          <div>
            <span
              class="font-bold text-white border border-gray-500 px-2 py-1 rounded mr-2"
              >CHU·ªòT</span
            >
            Nh√¨n quanh
          </div>
          <div>
            <span
              class="font-bold text-yellow-500 border border-yellow-500 px-2 py-1 rounded mr-2"
              >E</span
            >
            T∆∞∆°ng t√°c
          </div>
        </div>
        <button id="start-btn" class="btn-royal text-2xl px-12 py-4">
          B∆Ø·ªöC V√ÄO ƒê·∫†I N·ªòI
        </button>
      </div>
    </div>

    <!-- Modals (The 5 Artifacts) -->
    <!-- 1. T·ªïng quan -->
    <div id="modal-1" class="modal-overlay">
      <div class="modal-content">
        <button
          class="close-btn absolute top-4 right-4 text-gray-500 hover:text-yellow-500 text-3xl"
        >
          &times;
        </button>
        <h2 class="text-3xl text-yellow-500 mb-6 border-b border-red-900 pb-2">
          T·ªïng quan: Nh√£ nh·∫°c Cung ƒë√¨nh Hu·∫ø l√† g√¨?
        </h2>
        <div class="text-lg leading-relaxed space-y-4">
          <p>
            <strong>Nh√£ nh·∫°c</strong> (nghƒ©a ƒëen l√† "√¢m nh·∫°c ch√≠nh th·ªëng", "√¢m
            nh·∫°c thanh cao") l√† th·ªÉ lo·∫°i nh·∫°c c√≥ t√≠nh ch·∫•t nghi l·ªÖ qu·ªëc gia,
            ƒë∆∞·ª£c tr√¨nh di·ªÖn trong c√°c d·ªãp ƒë·∫°i l·ªÖ c·ªßa tri·ªÅu ƒë√¨nh phong ki·∫øn Vi·ªát
            Nam.
          </p>
          <p>
            D∆∞·ªõi tri·ªÅu Nguy·ªÖn (1802‚Äì1945), Nh√£ nh·∫°c ƒë·∫°t ƒë·∫øn ƒë·ªânh cao v·ªÅ s·ª± tinh
            t·∫ø, quy m√¥ t·ªï ch·ª©c v√† h·ªá th·ªëng l√Ω lu·∫≠n. ƒê√¢y kh√¥ng ch·ªâ l√† gi·∫£i tr√≠ m√†
            c√≤n l√†
            <span class="text-yellow-400 font-bold"
              >bi·ªÉu t∆∞·ª£ng cho quy·ªÅn l·ª±c v√† s·ª± tr∆∞·ªùng t·ªìn c·ªßa tri·ªÅu ƒë·∫°i</span
            >.
          </p>
        </div>
      </div>
    </div>

    <!-- 2. L·ªãch s·ª≠ -->
    <div id="modal-2" class="modal-overlay">
      <div class="modal-content">
        <button
          class="close-btn absolute top-4 right-4 text-gray-500 hover:text-yellow-500 text-3xl"
        >
          &times;
        </button>
        <h2 class="text-3xl text-yellow-500 mb-6 border-b border-red-900 pb-2">
          L·ªãch s·ª≠ h√¨nh th√†nh v√† ph√°t tri·ªÉn
        </h2>
        <p class="mb-6 italic">
          Qu√° tr√¨nh h√¨nh th√†nh c·ªßa Nh√£ nh·∫°c l√† m·ªôt d√≤ng ch·∫£y d√†i qua nhi·ªÅu th·∫ø
          k·ª∑:
        </p>
        <div class="pl-4">
          <div class="timeline-item">
            <h4 class="text-xl text-yellow-400">
              Th·ªùi L√Ω - Tr·∫ßn (Th·∫ø k·ª∑ 11-14)
            </h4>
            <p>
              B·∫Øt ƒë·∫ßu h√¨nh th√†nh. Ch·ªãu ·∫£nh h∆∞·ªüng b∆∞·ªõc ƒë·∫ßu t·ª´ √¢m nh·∫°c ChƒÉm-pa v√†
              √¢m nh·∫°c Trung Hoa.
            </p>
          </div>
          <div class="timeline-item">
            <h4 class="text-xl text-yellow-400">Th·ªùi L√™ S∆° (Th·∫ø k·ª∑ 15)</h4>
            <p>
              L∆∞∆°ng ƒêƒÉng thi·∫øt l·∫≠p h·ªá th·ªëng quy ƒë·ªãnh kh·∫Øt khe v·ªÅ nh·∫°c kh√≠, b√†i
              b·∫£n, t√°ch bi·ªát gi·ªØa nh·∫°c cung ƒë√¨nh v√† nh·∫°c d√¢n gian.
            </p>
          </div>
          <div class="timeline-item">
            <h4 class="text-xl text-yellow-400">Th·ªùi Nh√† Nguy·ªÖn (1802-1945)</h4>
            <p>
              Giai ƒëo·∫°n c·ª±c th·ªãnh. C√°c v·ªã vua nh∆∞ Gia Long, Minh M·∫°ng c·ª±c k·ª≥ ch√∫
              tr·ªçng. Nh√£ nh·∫°c ƒë∆∞·ª£c chu·∫©n h√≥a, c√≥ nh·∫°c ch∆∞∆°ng ri√™ng cho t·ª´ng nghi
              l·ªÖ (T·∫ø Giao, T·∫ø Mi·∫øu, ƒê·∫°i tri·ªÅu...).
            </p>
          </div>
          <div class="timeline-item">
            <h4 class="text-xl text-gray-400">Sau nƒÉm 1945</h4>
            <p>
              Tri·ªÅu ƒë·∫°i phong ki·∫øn k·∫øt th√∫c, Nh√£ nh·∫°c c√≥ nguy c∆° th·∫•t truy·ªÅn.
            </p>
          </div>
          <div class="timeline-item border-l-0">
            <h4 class="text-xl text-yellow-400 font-bold">NƒÉm 2003</h4>
            <p>
              UNESCO ch√≠nh th·ª©c c√¥ng nh·∫≠n Nh√£ nh·∫°c Cung ƒë√¨nh Hu·∫ø l√†
              <span class="text-white"
                >Ki·ªát t√°c di s·∫£n phi v·∫≠t th·ªÉ v√† truy·ªÅn kh·∫©u c·ªßa nh√¢n lo·∫°i</span
              >.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. Nh·∫°c kh√≠ -->
    <div id="modal-3" class="modal-overlay">
      <div class="modal-content">
        <button
          class="close-btn absolute top-4 right-4 text-gray-500 hover:text-yellow-500 text-3xl"
        >
          &times;
        </button>
        <h2 class="text-3xl text-yellow-500 mb-6 border-b border-red-900 pb-2">
          H·ªá th·ªëng Nh·∫°c kh√≠ v√† T·ªï ch·ª©c d√†n nh·∫°c
        </h2>
        <p class="mb-4">
          Nh√£ nh·∫°c kh√¥ng ph·∫£i l√† m·ªôt ban nh·∫°c ƒë∆°n l·∫ª m√† l√† m·ªôt h·ªá th·ªëng c√°c d√†n
          nh·∫°c kh√°c nhau t√πy theo quy m√¥ bu·ªïi l·ªÖ:
        </p>

        <div class="grid grid-cols-2 gap-6 mb-6">
          <div class="bg-black bg-opacity-50 p-4 border border-red-900 rounded">
            <h3 class="text-2xl text-red-400 mb-2">D√†n ƒê·∫°i nh·∫°c</h3>
            <p class="text-sm">
              Th∆∞·ªùng d√πng trong c√°c ƒë·∫°i l·ªÖ t·∫ø t·ª±. G·ªìm tr·ªëng l·ªõn (tr·ªëng chi·∫øn),
              k√®n b·∫ßu, x·∫≠p x√µa v√† c√°c lo·∫°i m√µ. √Çm thanh h√†o h√πng, uy nghi√™m.
            </p>
            <div class="css-3d-container">
              <div class="css-model">
                <div
                  class="drum-face"
                  style="transform: translateZ(20px)"
                ></div>
                <div
                  class="drum-face"
                  style="transform: translateZ(-20px)"
                ></div>
                <div class="drum-side"></div>
              </div>
            </div>
          </div>
          <div class="bg-black bg-opacity-50 p-4 border border-red-900 rounded">
            <h3 class="text-2xl text-yellow-300 mb-2">
              D√†n Ti·ªÉu nh·∫°c (Nh·∫°c Huy·ªÅn)
            </h3>
            <p class="text-sm">
              D√πng trong c√°c y·∫øn ti·ªác ho·∫∑c th∆∞·ªùng tri·ªÅu. G·ªìm ƒë√†n t·ª≥ b√†, ƒë√†n nh·ªã,
              ƒë√†n nguy·ªát, s√°o tr√∫c, tam √¢m la... √Çm thanh thanh tho√°t, nh√£ nh·∫∑n.
            </p>
            <div class="css-3d-container">
              <div class="css-model">
                <div class="lute-body"></div>
                <div class="lute-neck"></div>
              </div>
            </div>
          </div>
        </div>
        <ul class="list-disc pl-6 space-y-2">
          <li>
            <strong>Tr·ªëng:</strong>
            <span class="text-yellow-400">Linh h·ªìn c·ªßa d√†n nh·∫°c</span>, ƒëi·ªÅu
            khi·ªÉn nh·ªãp ƒë·ªô.
          </li>
          <li><strong>B·ªô d√¢y:</strong> ƒê√†n t·ª≥ b√†, ƒë√†n tam, ƒë√†n nguy·ªát.</li>
          <li><strong>B·ªô h∆°i:</strong> S√°o tr√∫c, k√®n b·∫ßu.</li>
        </ul>
      </div>
    </div>

    <!-- 4. Gi√° tr·ªã ngh·ªá thu·∫≠t -->
    <div id="modal-4" class="modal-overlay">
      <div class="modal-content">
        <button
          class="close-btn absolute top-4 right-4 text-gray-500 hover:text-yellow-500 text-3xl"
        >
          &times;
        </button>
        <h2 class="text-3xl text-yellow-500 mb-6 border-b border-red-900 pb-2">
          Gi√° tr·ªã ngh·ªá thu·∫≠t v√† Nh√¢n vƒÉn
        </h2>
        <p class="text-xl mb-6 italic text-gray-400">
          T·∫°i sao Nh√£ nh·∫°c l·∫°i ƒë∆∞·ª£c coi l√† b√°u v·∫≠t?
        </p>
        <div class="space-y-6">
          <div>
            <h4 class="text-2xl text-yellow-400 mb-2">
              S·ª± k·∫øt h·ª£p ƒëa lo·∫°i h√¨nh
            </h4>
            <p>
              Kh√¥ng ch·ªâ c√≥ nh·∫°c, Nh√£ nh·∫°c c√≤n ƒëi k√®m v·ªõi M√∫a cung ƒë√¨nh (nh∆∞ L·ª•c
              c√∫ng hoa ƒëƒÉng, L√¢n m·∫´u xu·∫•t l√¢n nhi...) v√† c√°c b√†i Nh·∫°c ch∆∞∆°ng
              (l·ªùi h√°t) gi√†u tri·∫øt l√Ω.
            </p>
          </div>
          <div>
            <h4 class="text-2xl text-yellow-400 mb-2">T√≠nh nguy√™n b·∫£n</h4>
            <p>
              D√π c√≥ ti·∫øp thu y·∫øu t·ªë t·ª´ n∆∞·ªõc ngo√†i, nh∆∞ng qua h√†ng trƒÉm nƒÉm,
              ng∆∞·ªùi Vi·ªát ƒë√£ "n·ªôi h√≥a" ƒë·ªÉ t·∫°o n√™n nh·ªØng giai ƒëi·ªáu mang ƒë·∫≠m t√¢m
              h·ªìn Vi·ªát.
            </p>
          </div>
          <div>
            <h4 class="text-2xl text-yellow-400 mb-2">K·ªπ nƒÉng ƒëi√™u luy·ªán</h4>
            <p>
              C√°c ngh·ªá nh√¢n x∆∞a ph·∫£i tr·∫£i qua qu√° tr√¨nh ƒë√†o t·∫°o c·ª±c k·ª≥ kh·∫Øc
              nghi·ªát ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c tr√¨nh ƒë·ªô di·ªÖn t·∫•u "nh∆∞ m·ªôt".
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- 5. Tr·∫£i nghi·ªám ng√†y nay -->
    <div id="modal-5" class="modal-overlay">
      <div class="modal-content">
        <button
          class="close-btn absolute top-4 right-4 text-gray-500 hover:text-yellow-500 text-3xl"
        >
          &times;
        </button>
        <h2 class="text-3xl text-yellow-500 mb-6 border-b border-red-900 pb-2">
          Th∆∞·ªüng th·ª©c Nh√£ nh·∫°c ·ªü ƒë√¢u ng√†y nay?
        </h2>
        <p class="mb-4">
          N·∫øu b·∫°n c√≥ d·ªãp ƒë·∫øn Hu·∫ø, ƒë·ª´ng b·ªè l·ª° c∆° h·ªôi tr·∫£i nghi·ªám "√¢m thanh c·ªßa
          b·∫≠c ƒë·∫ø v∆∞∆°ng" t·∫°i:
        </p>
        <ul class="list-disc pl-6 space-y-3 mb-8 text-lg">
          <li>
            <strong class="text-yellow-400">Duy·ªát Th·ªã ƒê∆∞·ªùng:</strong> Nh√† h√°t c·ªï
            nh·∫•t Vi·ªát Nam n·∫±m b√™n trong T·ª≠ C·∫•m Th√†nh.
          </li>
          <li>
            <strong class="text-yellow-400">Minh Khi√™m ƒê∆∞·ªùng:</strong> N·∫±m trong
            khu√¥n vi√™n LƒÉng T·ª± ƒê·ª©c.
          </li>
          <li>
            <strong class="text-yellow-400">C√°c l·ªÖ h·ªôi Festival Hu·∫ø:</strong>
            N∆°i c√°c bu·ªïi ƒë·∫°i t·∫ø ƒë∆∞·ª£c ph·ª•c d·ª±ng ho√†nh tr√°ng.
          </li>
        </ul>
        <div
          class="bg-red-900 bg-opacity-40 border border-red-500 p-4 rounded-lg"
        >
          <h4 class="text-xl text-yellow-300 mb-2">‚ú® M·ªôt ch√∫t th√∫ v·ªã:</h4>
          <p>
            B·∫°n c√≥ bi·∫øt r·∫±ng d∆∞·ªõi th·ªùi Nguy·ªÖn, m·ªói khi vua b∆∞·ªõc ƒëi,
            <span class="font-bold text-white"
              >nh·∫°c c√¥ng ph·∫£i t·∫•u nh·∫°c theo t·ª´ng nh·ªãp b∆∞·ªõc c·ªßa vua</span
            >
            ƒë·ªÉ t·∫°o s·ª± trang tr·ªçng tuy·ªát ƒë·ªëi?
          </p>
        </div>
      </div>
    </div>

    <!-- End Game Cinematic Layer -->
    <div id="cinematic-layer">
      <video id="end-video" src="nha-nhac.mp4" playsinline></video>

      <div
        id="end-buttons"
        class="absolute bottom-20 flex space-x-6 opacity-0 transition-opacity duration-1000 z-50"
      >
        <button
          onclick="window.location.href = '../../index.html'"
          class="btn-royal"
        >
          V·ªÅ Trang Ch·ªß
        </button>
        <button
          onclick="window.location.href = 'bai_tap_nha_nhac.html'"
          class="btn-royal"
          style="border-color: #fff; color: #fff"
        >
          L√†m B√†i T·∫≠p
        </button>
      </div>
    </div>

    <!-- Three.js Library & Scripts -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
      }
    </script>

    <script type="module">
      import * as THREE from "three";
      import { PointerLockControls } from "three/addons/controls/PointerLockControls.js";

      // --- GAME STATE ---
      let discoveredItems = new Set();
      const totalItems = 5;
      let isGamePaused = true;
      let currentIntersected = null;

      // --- AUDIO SYNTHESIS (No external files needed) ---
      let audioCtx;
      function initAudio() {
        if (audioCtx) return;
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Create a deep, solemn drone (Imperial atmosphere)
        const osc1 = audioCtx.createOscillator();
        const osc2 = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        const filter = audioCtx.createBiquadFilter();

        osc1.type = "sine";
        osc1.frequency.value = 55; // Low A
        osc2.type = "triangle";
        osc2.frequency.value = 110; // A octave higher

        filter.type = "lowpass";
        filter.frequency.value = 200;

        gain.gain.value = 0.2; // Keep it ambient

        osc1.connect(filter);
        osc2.connect(filter);
        filter.connect(gain);
        gain.connect(audioCtx.destination);

        osc1.start();
        osc2.start();
      }

      // --- THREE.JS SETUP ---
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0a0502); // Dark night/dusk
      scene.fog = new THREE.FogExp2(0x0a0502, 0.015);

      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000,
      );
      camera.position.y = 1.6; // Eye level

      const renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      document
        .getElementById("game-container")
        .appendChild(renderer.domElement);

      const controls = new PointerLockControls(camera, document.body);

      const blocker = document.getElementById("blocker");
      const startBtn = document.getElementById("start-btn");

      startBtn.addEventListener("click", function () {
        controls.lock();
        initAudio();
        if (audioCtx.state === "suspended") audioCtx.resume();
      });

      controls.addEventListener("lock", function () {
        blocker.style.display = "none";
        isGamePaused = false;
      });

      controls.addEventListener("unlock", function () {
        if (
          !document.querySelector('.modal-overlay[style*="display: flex"]') &&
          document.getElementById("cinematic-layer").style.display !== "flex"
        ) {
          blocker.style.display = "flex";
        }
        isGamePaused = true;
      });

      // --- ENVIRONMENT: HUE CITADEL PROCEDURAL GENERATION ---

      // Lighting
      const ambientLight = new THREE.AmbientLight(0xffe4b5, 0.2); // Dim warm light
      scene.add(ambientLight);

      const moonLight = new THREE.DirectionalLight(0x708090, 0.5);
      moonLight.position.set(-50, 50, -50);
      moonLight.castShadow = true;
      moonLight.shadow.camera.top = 50;
      moonLight.shadow.camera.bottom = -50;
      moonLight.shadow.camera.left = -50;
      moonLight.shadow.camera.right = 50;
      scene.add(moonLight);

      // Materials
      const floorMat = new THREE.MeshStandardMaterial({
        color: 0x2a2a2a,
        roughness: 0.9,
      });
      const columnMat = new THREE.MeshStandardMaterial({
        color: 0x8b0000,
        roughness: 0.7,
      }); // Royal Red
      const stoneMat = new THREE.MeshStandardMaterial({
        color: 0x505050,
        roughness: 0.8,
      });
      const roofMat = new THREE.MeshStandardMaterial({
        color: 0xb8860b,
        roughness: 0.5,
      }); // Gold/Yellow

      // Floor (S√¢n R·ªìng)
      const floorGeo = new THREE.PlaneGeometry(100, 100);
      const floor = new THREE.Mesh(floorGeo, floorMat);
      floor.rotation.x = -Math.PI / 2;
      floor.receiveShadow = true;
      scene.add(floor);

      // Main Platform (ƒêi·ªán Th√°i H√≤a base)
      const platformGeo = new THREE.BoxGeometry(40, 1, 30);
      const platform = new THREE.Mesh(platformGeo, stoneMat);
      platform.position.set(0, 0.5, -20);
      platform.receiveShadow = true;
      scene.add(platform);

      // Columns
      const columnGeo = new THREE.CylinderGeometry(0.4, 0.4, 8, 16);
      for (let i = 0; i < 5; i++) {
        for (let j = 0; j < 2; j++) {
          const col = new THREE.Mesh(columnGeo, columnMat);
          col.position.set(-15 + i * 7.5, 4.5, -15 - j * 10);
          col.castShadow = true;
          col.receiveShadow = true;
          scene.add(col);
        }
      }

      // Roof (Abstract representation)
      const roofGeo = new THREE.ConeGeometry(25, 6, 4);
      const roof = new THREE.Mesh(roofGeo, roofMat);
      roof.position.set(0, 11, -20);
      roof.rotation.y = Math.PI / 4;
      scene.add(roof);

      // --- ARTIFACTS (Quest Items) ---
      const artifacts = [];
      const interactables = [];

      const artifactData = [
        { id: 1, pos: [-10, 1, -5], type: "box", color: 0xdaa520 }, // T·ªïng quan (Scroll box)
        { id: 2, pos: [10, 1, -5], type: "stele", color: 0x808080 }, // L·ªãch s·ª≠ (Stele)
        { id: 3, pos: [0, 1.5, -15], type: "drum", color: 0x8b0000 }, // Nh·∫°c kh√≠ (Drum)
        { id: 4, pos: [-15, 1, 5], type: "pedestal", color: 0xcd853f }, // Ngh·ªá thu·∫≠t (Pedestal)
        { id: 5, pos: [15, 1, 5], type: "lantern", color: 0xff4500 }, // Tr·∫£i nghi·ªám (Lantern)
      ];

      const glowMat = new THREE.MeshBasicMaterial({
        color: 0xffd700,
        transparent: true,
        opacity: 0.3,
        blending: THREE.AdditiveBlending,
        side: THREE.BackSide,
      });

      artifactData.forEach((data) => {
        let geo;
        if (data.type === "box") geo = new THREE.BoxGeometry(0.8, 0.4, 0.8);
        else if (data.type === "stele") geo = new THREE.BoxGeometry(1, 2, 0.2);
        else if (data.type === "drum")
          geo = new THREE.CylinderGeometry(0.6, 0.6, 0.8, 32);
        else if (data.type === "pedestal")
          geo = new THREE.CylinderGeometry(0.4, 0.5, 1.2, 8);
        else geo = new THREE.SphereGeometry(0.5, 16, 16);

        const mat = new THREE.MeshStandardMaterial({
          color: data.color,
          metalness: 0.3,
          roughness: 0.4,
        });
        const mesh = new THREE.Mesh(geo, mat);
        mesh.position.set(data.pos[0], data.pos[1], data.pos[2]);
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        mesh.userData = { id: data.id };

        // Add point light for dramatic effect
        const light = new THREE.PointLight(0xffd700, 1, 5);
        light.position.set(0, 1, 0);
        mesh.add(light);

        // Add glow mesh
        const glowMesh = new THREE.Mesh(geo.clone(), glowMat);
        glowMesh.scale.set(1.2, 1.2, 1.2);
        mesh.add(glowMesh);

        scene.add(mesh);
        interactables.push(mesh);
        artifacts.push(mesh);
      });

      // --- MOVEMENT & CONTROLS ---
      const moveState = {
        forward: false,
        backward: false,
        left: false,
        right: false,
      };
      const velocity = new THREE.Vector3();
      const direction = new THREE.Vector3();
      const speed = 40.0;
      let prevTime = performance.now();

      document.addEventListener("keydown", (e) => {
        switch (e.code) {
          case "KeyW":
            moveState.forward = true;
            break;
          case "KeyS":
            moveState.backward = true;
            break;
          case "KeyA":
            moveState.left = true;
            break;
          case "KeyD":
            moveState.right = true;
            break;
          case "KeyE":
            handleInteraction();
            break;
        }
      });

      document.addEventListener("keyup", (e) => {
        switch (e.code) {
          case "KeyW":
            moveState.forward = false;
            break;
          case "KeyS":
            moveState.backward = false;
            break;
          case "KeyA":
            moveState.left = false;
            break;
          case "KeyD":
            moveState.right = false;
            break;
        }
      });

      // --- INTERACTION LOGIC ---
      const raycaster = new THREE.Raycaster();
      const centerPoint = new THREE.Vector2(0, 0);
      const tooltip = document.getElementById("tooltip");
      const crosshair = document.getElementById("crosshair");

      function handleInteraction() {
        if (currentIntersected && !isGamePaused) {
          const id = currentIntersected.userData.id;
          openModal(id);
        }
      }

      function openModal(id) {
        controls.unlock();
        const modal = document.getElementById(`modal-${id}`);
        if (modal) {
          modal.style.display = "flex";

          // Update Progress
          if (!discoveredItems.has(id)) {
            discoveredItems.add(id);
            document.getElementById("progress-text").innerText =
              discoveredItems.size;
            const questLi = document.getElementById(`q${id}`);
            questLi.classList.remove("text-gray-500");
            questLi.classList.add("text-yellow-400", "font-bold");
            questLi.innerText += " ‚úì";

            // Stop glow
            currentIntersected.children[1].visible = false;
            currentIntersected.children[0].intensity = 0.2; // dim light

            if (discoveredItems.size === totalItems) {
              setTimeout(() => {
                modal.style.display = "none";
                startCinematic();
              }, 2000); // 2 seconds reading time then auto trigger cinematic if last item
            }
          }
        }
      }

      // Close Modals setup
      document.querySelectorAll(".close-btn").forEach((btn) => {
        btn.addEventListener("click", function (e) {
          e.target.closest(".modal-overlay").style.display = "none";
          if (discoveredItems.size < totalItems) {
            controls.lock(); // return to game
          } else {
            startCinematic();
          }
        });
      });

      // --- CINEMATIC SEQUENCE ---
      function startCinematic() {
        document.getElementById("ui-layer").style.display = "none";
        const cineLayer = document.getElementById("cinematic-layer");
        cineLayer.style.display = "flex";

        const video = document.getElementById("end-video");
        const btns = document.getElementById("end-buttons");

        // T·∫Øt √¢m thanh n·ªÅn c·ªßa game ƒë·ªÉ nghe ti·∫øng video
        if (audioCtx && audioCtx.state === "running") {
          audioCtx.suspend();
        }

        // Ph√°t video
        video.play().catch((e) => {
          console.warn(
            "Kh√¥ng th·ªÉ ph√°t video (thi·∫øu file nha-nhac.mp4 ho·∫∑c tr√¨nh duy·ªát ch·∫∑n):",
            e,
          );
          // N·∫øu c√≥ l·ªói, v·∫´n cho ph√©p ng∆∞·ªùi ch∆°i nh√¨n th·∫•y n√∫t b·∫•m
          btns.style.opacity = "1";
          btns.style.pointerEvents = "auto";
        });

        // Khi video k·∫øt th√∫c, t·ª± ƒë·ªông hi·ªán 2 n√∫t
        video.onended = () => {
          btns.style.opacity = "1";
          btns.style.pointerEvents = "auto";
        };
      }

      // --- MAIN ANIMATION LOOP ---
      function animate() {
        requestAnimationFrame(animate);

        const time = performance.now();

        // Artifact Animation (floating)
        artifacts.forEach((mesh, index) => {
          mesh.position.y += Math.sin(time * 0.002 + index) * 0.002;
          mesh.rotation.y += 0.005;
        });

        if (controls.isLocked) {
          // Raycasting for Interaction
          raycaster.setFromCamera(centerPoint, camera);
          const intersects = raycaster.intersectObjects(interactables);

          if (intersects.length > 0 && intersects[0].distance < 4) {
            if (currentIntersected !== intersects[0].object) {
              currentIntersected = intersects[0].object;
              crosshair.classList.add("active");
              if (!discoveredItems.has(currentIntersected.userData.id)) {
                tooltip.style.opacity = 1;
              }
            }
          } else {
            currentIntersected = null;
            crosshair.classList.remove("active");
            tooltip.style.opacity = 0;
          }

          // Movement physics
          const delta = (time - prevTime) / 1000;

          velocity.x -= velocity.x * 10.0 * delta;
          velocity.z -= velocity.z * 10.0 * delta;

          direction.z = Number(moveState.forward) - Number(moveState.backward);
          direction.x = Number(moveState.right) - Number(moveState.left);
          direction.normalize();

          if (moveState.forward || moveState.backward)
            velocity.z -= direction.z * speed * delta;
          if (moveState.left || moveState.right)
            velocity.x -= direction.x * speed * delta;

          controls.moveRight(-velocity.x * delta);
          controls.moveForward(-velocity.z * delta);

          // Simple Boundary Collision
          if (camera.position.x < -40) camera.position.x = -40;
          if (camera.position.x > 40) camera.position.x = 40;
          if (camera.position.z < -40) camera.position.z = -40;
          if (camera.position.z > 40) camera.position.z = 40;
        }

        prevTime = time;
        renderer.render(scene, camera);
      }

      // Handle Window Resize
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // Start Loop
      animate();
      // ===== AUTO PLAY NH√É NH·∫†C =====

      const backgroundMusic = new Audio("nha-nhac.mp3");
      backgroundMusic.loop = true;
      backgroundMusic.volume = 0.6;

      // Th·ª≠ autoplay ngay khi load
      window.addEventListener("load", async () => {
        try {
          await backgroundMusic.play();
          console.log("Nh√£ nh·∫°c ƒëang ph√°t üé∂");
        } catch (err) {
          console.warn("Autoplay b·ªã ch·∫∑n. Ch·ªù ng∆∞·ªùi d√πng t∆∞∆°ng t√°c...");

          // Khi ng∆∞·ªùi d√πng click l·∫ßn ƒë·∫ßu s·∫Ω ph√°t
          const startMusic = () => {
            backgroundMusic.play();
            document.removeEventListener("click", startMusic);
          };

          document.addEventListener("click", startMusic);
        }
      });
    </script>
  </body>
</html>
