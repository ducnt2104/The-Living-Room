<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bảo tàng 3D Điện Biên Phủ - Fix Bug</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;700&family=Be+Vietnam+Pro:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #050505;
        font-family: "Be Vietnam Pro", sans-serif;
      }

      #crosshair {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 10px;
        height: 10px;
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        z-index: 100;
        pointer-events: none;
      }

      #quest-tracker {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(10, 10, 10, 0.85);
        border: 1px solid #d4af37;
        padding: 15px;
        color: white;
        border-radius: 12px;
        z-index: 100;
        backdrop-filter: blur(10px);
        min-width: 200px;
      }

      .artifact-card {
        background: linear-gradient(
          135deg,
          rgba(20, 18, 15, 0.98),
          rgba(10, 8, 5, 0.99)
        );
        border: 1px solid #d4af37;
        display: none;
        pointer-events: all;
        max-height: 90vh;
        width: 95%;
        max-width: 900px;
        backdrop-filter: blur(20px);
        box-shadow: 0 0 50px rgba(0, 0, 0, 1);
      }

      #blocker {
        position: absolute;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          circle,
          rgba(20, 20, 20, 0.7) 0%,
          rgba(0, 0, 0, 1) 100%
        );
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 500;
        color: white;
        text-align: center;
        cursor: pointer;
      }

      .hint {
        position: fixed;
        bottom: 15%;
        left: 50%;
        transform: translateX(-50%);
        color: #d4af37;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 2px 2px 8px black;
        display: none;
        z-index: 50;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: #222;
        border-radius: 3px;
        margin-top: 10px;
        overflow: hidden;
      }
      #progress-fill {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #d4af37, #f1c40f);
        transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #video-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: black;
        z-index: 2000;
      }

      #artifact-content::-webkit-scrollbar {
        width: 5px;
      }
      #artifact-content::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
      }
      #artifact-content::-webkit-scrollbar-thumb {
        background: #d4af37;
        border-radius: 10px;
      }

      .close-btn {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 50%;
        cursor: pointer;
        transition: 0.3s ease;
        color: #888;
        border: 1px solid transparent;
      }
      .close-btn:hover {
        background: rgba(220, 38, 38, 0.2);
        color: white;
        border-color: rgba(220, 38, 38, 0.5);
        transform: rotate(90deg);
      }
    </style>
  </head>
  <body>
    <div id="blocker">
      <div
        class="max-w-xl p-10 bg-black/40 border border-yellow-900/50 rounded-3xl backdrop-blur-xl"
      >
        <h1
          class="text-6xl font-bold mb-6 text-yellow-500 font-serif uppercase tracking-tighter"
        >
          Điện Biên Phủ
        </h1>
        <p
          id="main-status"
          class="text-lg text-gray-400 mb-8 font-light italic"
        >
          "Chấn động địa cầu - Bản hùng ca của lòng yêu nước"
        </p>
        <div
          class="space-y-4 text-left text-sm text-gray-500 mb-8 border-l-2 border-yellow-700/30 pl-6"
        >
          <p>• Di chuyển bằng phím <b>WASD</b></p>
          <p>• Quan sát bằng <b>Chuột</b></p>
          <p>• Nhấp <b>Chuột trái</b> vào vật thể để xem thuyết minh</p>
        </div>
        <button
          id="start-btn"
          class="w-full bg-yellow-600 hover:bg-yellow-500 text-black px-10 py-4 rounded-xl font-bold transition-all uppercase tracking-widest shadow-lg shadow-yellow-900/20"
        >
          Bắt đầu khám phá
        </button>
      </div>
    </div>

    <div id="quest-tracker">
      <h4
        class="text-[10px] uppercase tracking-[0.2em] text-yellow-600 font-bold mb-1"
      >
        Nhiệm vụ thu thập
      </h4>
      <div class="text-2xl font-bold font-serif tracking-tight text-white">
        <span id="quest-count">0</span> / 5
      </div>
      <div class="progress-bar"><div id="progress-fill"></div></div>
      <p
        id="quest-msg"
        class="text-[9px] text-gray-500 mt-2 uppercase tracking-wider italic"
      >
        Tìm kiếm dấu tích lịch sử...
      </p>
    </div>

    <div id="crosshair"></div>
    <div id="hint" class="hint">Tương tác (Chuột trái)</div>

    <div
      id="info-panel"
      class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-[600] artifact-card rounded-3xl overflow-hidden shadow-2xl"
    >
      <div class="close-btn" onclick="closePanel()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </div>
      <div class="p-8 md:p-14">
        <div class="flex items-center gap-4 mb-2">
          <span class="h-px w-12 bg-yellow-600"></span>
          <span
            class="text-yellow-600 text-xs font-bold uppercase tracking-[0.3em]"
            >Hồ sơ hiện vật</span
          >
        </div>
        <h2
          id="artifact-name"
          class="text-4xl md:text-5xl font-bold text-yellow-500 mb-8 font-serif uppercase leading-none"
        ></h2>

        <div
          id="artifact-content"
          class="text-gray-300 leading-relaxed text-lg h-[40vh] overflow-y-auto pr-6 mb-8 font-light border-l border-yellow-900/20 pl-8"
        ></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
          <div class="bg-white/5 p-6 rounded-2xl border border-white/10">
            <h4
              class="text-yellow-500 font-bold text-xs uppercase mb-3 tracking-widest flex items-center gap-2"
            >
              Giá trị chiến thuật
            </h4>
            <p
              id="artifact-tactic"
              class="text-gray-400 text-sm leading-relaxed italic"
            ></p>
          </div>
          <div class="bg-white/5 p-6 rounded-2xl border border-white/10">
            <h4
              class="text-yellow-500 font-bold text-xs uppercase mb-3 tracking-widest flex items-center gap-2"
            >
              Dấu ấn lịch sử
            </h4>
            <p
              id="artifact-history"
              class="text-gray-400 text-sm leading-relaxed italic"
            ></p>
          </div>
        </div>

        <div class="flex justify-end">
          <button
            onclick="closePanel()"
            class="bg-yellow-600 hover:bg-yellow-500 text-black px-12 py-3 rounded-full font-bold transition-all uppercase text-xs tracking-widest"
          >
            Đóng & Tiếp tục
          </button>
        </div>
      </div>
    </div>

    <div id="video-overlay">
      <div
        class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black pointer-events-none z-10"
      ></div>
      <button
        onclick="closeVideo()"
        class="absolute top-12 right-12 z-50 bg-white/10 hover:bg-red-600 w-12 h-12 rounded-full flex items-center justify-center transition-all"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="white"
          stroke-width="2"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <video id="full-video" class="w-full h-full object-cover">
        <source
          src="https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4"
          type="video/mp4"
        />
      </video>
    </div>

    <script type="module">
      import * as THREE from "https://cdn.skypack.dev/three@0.128.0/build/three.module.js";
      import { PointerLockControls } from "https://cdn.skypack.dev/three@0.128.0/examples/jsm/controls/PointerLockControls.js";

      const artifactsData = {
        a1_hill: {
          name: "Hố bộc phá Đồi A1",
          content: `Đồi A1 (Eliane 2) là điểm cao quan trọng nhất. Quân Pháp xây hệ thống hầm ngầm kiên cố. Để giải quyết, công binh ta đào hầm dài 47m và đặt 960kg thuốc nổ. Đêm 6/5/1954, khối bộc phá nổ tung, tạo hiệu lệnh tổng công kích tiêu diệt tập đoàn cứ điểm.`,
          tactic:
            "Đánh sập hầm ngầm bằng bộc phá khối lượng lớn dưới lòng đất.",
          history: "Tiếng nổ quyết định mở đường cho ngày đại thắng 7/5.",
        },
        de_castries: {
          name: "Hầm Tướng De Castries",
          content: `Nằm tại trung tâm Mường Thanh, đây là nơi tướng De Castries chỉ huy. Hầm lợp mái vòm sắt uốn cong cực kỳ vững chãi. Chiều 7/5/1954, tổ xung kích của ta bắt sống tướng De Castries ngay tại bàn làm việc.`,
          tactic: "Tiêu diệt cơ quan đầu não địch.",
          history:
            "Nơi chứng kiến sự đầu hàng của thực dân Pháp tại Đông Dương.",
        },
        artillery: {
          name: "Pháo 105mm",
          content: `Quân ta đã kéo pháo bằng tay qua những dãy núi cao dựng đứng. Sự xuất hiện bất ngờ của hỏa lực pháo binh ta từ các đỉnh núi đã làm tê liệt sân bay Mường Thanh ngay từ những giờ đầu chiến dịch.`,
          tactic: "Hỏa lực áp đảo từ địa hình cao bất ngờ.",
          history: "Kỳ tích kéo pháo bằng sức người vĩ đại của quân dân ta.",
        },
        muong_phang: {
          name: "Sở chỉ huy Mường Phăng",
          content: `Ẩn mình dưới tán rừng cổ thụ, đây là nơi Đại tướng Võ Nguyên Giáp đưa ra quyết định lịch sử: Chuyển từ 'Đánh nhanh thắng nhanh' sang 'Đánh chắc tiến chắc'.`,
          tactic: "Chỉ huy linh hoạt, sát sao thực tế chiến trường.",
          history: "Linh hồn chiến lược của chiến thắng Điện Biên Phủ.",
        },
        victory_statue: {
          name: "Tượng đài Chiến thắng",
          content: `Công trình bằng đồng nặng 220 tấn tái hiện hình ảnh 3 chiến sĩ và em bé dân tộc Thái, biểu trưng cho sức mạnh đoàn kết toàn dân tộc dẫn tới thắng lợi cuối cùng.`,
          tactic: "Tập hợp sức mạnh tổng lực của nhân dân.",
          history:
            "Biểu tượng hòa bình và lòng kiêu hãnh của dân tộc Việt Nam.",
        },
      };

      let scene, camera, renderer, controls;
      let moveForward = false,
        moveBackward = false,
        moveLeft = false,
        moveRight = false;
      let velocity = new THREE.Vector3();
      let direction = new THREE.Vector3();
      let artifacts = [];
      let visited = new Set();
      let prevTime = performance.now();

      init();
      animate();

      function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        scene.fog = new THREE.Fog(0x050505, 0, 45);

        camera = new THREE.PerspectiveCamera(
          70,
          window.innerWidth / window.innerHeight,
          0.1,
          1000,
        );
        camera.position.set(0, 1.6, 5);

        const ambient = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambient);

        const spotLight = new THREE.SpotLight(0xd4af37, 1);
        spotLight.position.set(0, 20, 0);
        scene.add(spotLight);

        controls = new PointerLockControls(camera, document.body);
        const blocker = document.getElementById("blocker");
        const startBtn = document.getElementById("start-btn");

        startBtn.addEventListener("click", () => {
          controls.lock();
        });

        controls.addEventListener("lock", () => {
          blocker.style.display = "none";
        });

        controls.addEventListener("unlock", () => {
          if (
            document.getElementById("info-panel").style.display !== "block" &&
            document.getElementById("video-overlay").style.display !== "block"
          ) {
            blocker.style.display = "flex";
            document.getElementById("start-btn").innerText =
              "Tiếp tục khám phá";
          }
        });

        // Sàn đá
        const floorGeo = new THREE.PlaneGeometry(100, 100);
        const floorMat = new THREE.MeshStandardMaterial({
          color: 0x080808,
          roughness: 0.2,
          metalness: 0.3,
        });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        buildMuseum();

        // Vị trí hiện vật
        addArt(0, -15, "a1_hill", 0xcc0000);
        addArt(18, -10, "de_castries", 0x555555);
        addArt(-18, -10, "artillery", 0x1a331a);
        addArt(12, -28, "muong_phang", 0x5d4037);
        addArt(-12, -28, "victory_statue", 0xd4af37);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        window.addEventListener("resize", onWindowResize);
        document.addEventListener("keydown", onKeyDown);
        document.addEventListener("keyup", onKeyUp);
        document.addEventListener("mousedown", onMouseDown);
      }

      function buildMuseum() {
        const wallMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
        const wallBack = new THREE.Mesh(
          new THREE.BoxGeometry(60, 15, 1),
          wallMat,
        );
        wallBack.position.set(0, 7.5, -40);
        scene.add(wallBack);

        // Cột
        const colGeo = new THREE.BoxGeometry(1.5, 15, 1.5);
        for (let x = -28; x <= 28; x += 14) {
          const col = new THREE.Mesh(colGeo, wallMat);
          col.position.set(x, 7.5, -5);
          scene.add(col);
          const colB = col.clone();
          colB.position.z = -25;
          scene.add(colB);
        }
      }

      function addArt(x, z, id, color) {
        const group = new THREE.Group();
        group.position.set(x, 0, z);

        const pedestal = new THREE.Mesh(
          new THREE.BoxGeometry(2.5, 1, 2.5),
          new THREE.MeshStandardMaterial({ color: 0x1a1a1a, metalness: 0.5 }),
        );
        pedestal.position.y = 0.5;
        group.add(pedestal);

        // Hiện vật trực quan hơn
        let model;
        if (id === "artillery") {
          model = new THREE.Mesh(
            new THREE.CylinderGeometry(0.2, 0.2, 2),
            new THREE.MeshStandardMaterial({ color: color }),
          );
          model.rotation.z = Math.PI / 4;
        } else if (id === "de_castries") {
          model = new THREE.Mesh(
            new THREE.SphereGeometry(
              0.8,
              16,
              8,
              0,
              Math.PI * 2,
              0,
              Math.PI / 2,
            ),
            new THREE.MeshStandardMaterial({ color: color }),
          );
        } else {
          model = new THREE.Mesh(
            new THREE.IcosahedronGeometry(0.8),
            new THREE.MeshStandardMaterial({ color: color, metalness: 0.6 }),
          );
        }
        model.position.y = 2;
        model.userData = { id: id };
        group.add(model);

        const light = new THREE.PointLight(0xd4af37, 2, 10);
        light.position.y = 4;
        group.add(light);

        artifacts.push(model);
        scene.add(group);
      }

      function onKeyDown(e) {
        if (!controls.isLocked) return;
        switch (e.code) {
          case "KeyW":
            moveForward = true;
            break;
          case "KeyA":
            moveLeft = true;
            break;
          case "KeyS":
            moveBackward = true;
            break;
          case "KeyD":
            moveRight = true;
            break;
        }
      }

      function onKeyUp(e) {
        switch (e.code) {
          case "KeyW":
            moveForward = false;
            break;
          case "KeyA":
            moveLeft = false;
            break;
          case "KeyS":
            moveBackward = false;
            break;
          case "KeyD":
            moveRight = false;
            break;
        }
      }

      function onMouseDown() {
        if (!controls.isLocked) return;
        const ray = new THREE.Raycaster();
        ray.setFromCamera(new THREE.Vector2(), camera);
        const hits = ray.intersectObjects(artifacts);
        if (hits.length > 0) {
          const id = hits[0].object.userData.id;
          visited.add(id);
          updateUI();
          openPanel(id);
        }
      }

      function updateUI() {
        const count = visited.size;
        document.getElementById("quest-count").innerText = count;
        document.getElementById("progress-fill").style.width =
          (count / 5) * 100 + "%";
        if (count === 5) {
          document.getElementById("quest-msg").innerText =
            "Nhiệm vụ hoàn thành! Phim đã mở khóa.";
          document.getElementById("quest-msg").style.color = "#4ade80";
        }
      }

      function openPanel(id) {
        const data = artifactsData[id];
        document.getElementById("artifact-name").innerText = data.name;
        document.getElementById("artifact-content").innerHTML = data.content;
        document.getElementById("artifact-tactic").innerText = data.tactic;
        document.getElementById("artifact-history").innerText = data.history;

        controls.unlock();
        document.getElementById("info-panel").style.display = "block";
      }

      window.closePanel = function () {
        document.getElementById("info-panel").style.display = "none";
        if (visited.size === 5) {
          document.getElementById("video-overlay").style.display = "block";
          document.getElementById("full-video").play();
        } else {
          controls.lock(); // Tự động khóa lại để chơi tiếp
        }
      };

      window.closeVideo = function () {
        document.getElementById("full-video").pause();
        document.getElementById("video-overlay").style.display = "none";
        controls.lock();
      };

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }

      function animate() {
        requestAnimationFrame(animate);
        const time = performance.now();
        if (controls.isLocked) {
          const delta = (time - prevTime) / 1000;
          velocity.x -= velocity.x * 10.0 * delta;
          velocity.z -= velocity.z * 10.0 * delta;
          direction.z = Number(moveForward) - Number(moveBackward);
          direction.x = Number(moveRight) - Number(moveLeft);
          direction.normalize();
          if (moveForward || moveBackward)
            velocity.z -= direction.z * 100.0 * delta;
          if (moveLeft || moveRight) velocity.x -= direction.x * 100.0 * delta;
          controls.moveRight(-velocity.x * delta);
          controls.moveForward(-velocity.z * delta);

          const ray = new THREE.Raycaster();
          ray.setFromCamera(new THREE.Vector2(), camera);
          const hits = ray.intersectObjects(artifacts);
          document.getElementById("hint").style.display =
            hits.length > 0 ? "block" : "none";
        }

        artifacts.forEach((art) => {
          art.rotation.y += 0.01;
          art.position.y = 2 + Math.sin(time / 500) * 0.1;
          if (visited.has(art.userData.id)) {
            art.parent.children[2].color.set(0x00ff00); // Chuyển sang xanh lá khi đã khám phá
          }
        });

        prevTime = time;
        renderer.render(scene, camera);
      }
    </script>
  </body>
</html>
